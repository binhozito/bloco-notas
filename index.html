<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bloco de Notas Juca (Cloud)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* MANTIVE O MESMO ESTILO VISUAL, APENAS ADICIONEI ITENS DA NUVEM */
    :root {
      --bg-body: #050505; --bg-window: #202020; --bg-window-alt: #1b1b1b;
      --bg-tabbar: #252525; --bg-tab-active: #333333; --bg-tab-hover: #303030;
      --bg-status: #191919; --fg-text: #f5f5f5; --fg-text-muted: #a5a5a5;
      --border-window: #323232; --border-tab: #3a3a3a; --accent: #4cc2ff;
      --font-ui: system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    body { background: #000; color: var(--fg-text); font-family: var(--font-ui); display: flex; }
    
    /* LOGIN & MODAIS */
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
    }
    .box {
      background: var(--bg-window); padding: 30px; border-radius: 8px;
      border: 1px solid var(--border-window); text-align: center; width: 320px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }
    .box h2 { margin-bottom: 15px; font-size: 18px; color: var(--accent); }
    .box p { font-size: 12px; color: #aaa; margin-bottom: 15px; line-height: 1.4; }
    .input-field {
      width: 100%; padding: 10px; margin-bottom: 15px; background: #111;
      border: 1px solid #333; color: white; border-radius: 4px; outline: none;
    }
    .input-field:focus { border-color: var(--accent); }
    .btn {
      width: 100%; padding: 10px; background: var(--accent); border: none;
      color: #000; font-weight: bold; border-radius: 4px; cursor: pointer;
    }
    .btn:hover { background: #5fd1ff; }
    .btn-secondary { background: #333; color: #ccc; margin-top: 10px; }
    .btn-secondary:hover { background: #444; color: #fff; }
    .error-msg { color: #ff5555; font-size: 12px; margin-top: 10px; display: none; }

    /* LAYOUT APP */
    .window { width: 100vw; height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #121212; }
    
    .tab-bar {
      height: 38px; background: var(--bg-tabbar); display: flex; align-items: flex-end; padding: 0 6px; gap: 4px; border-bottom: 1px solid #333;
    }
    .app-icon {
      width: 24px; height: 24px; margin-bottom: 6px; margin-right: 8px; border-radius: 4px;
      background: linear-gradient(to bottom, #3aa7ff, #14508f);
    }
    .tabs-container { flex: 1; display: flex; overflow-x: auto; gap: 2px; scrollbar-width: none; }
    .tab {
      padding: 8px 12px; background: #222; color: #888; border-radius: 6px 6px 0 0;
      font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; min-width: 100px;
    }
    .tab.active { background: #333; color: #fff; }
    .tab-close { border: none; background: transparent; color: inherit; cursor: pointer; font-weight: bold; }
    .add-tab { background: transparent; border: none; color: #888; font-size: 20px; cursor: pointer; padding: 0 10px; margin-bottom: 5px; }
    
    .content { flex: 1; display: flex; flex-direction: column; background: var(--bg-window-alt); position: relative; }
    
    .editor {
      flex: 1; width: 100%; background: transparent; border: none; resize: none; outline: none;
      color: var(--fg-text); font-family: monospace; font-size: 16px; padding: 15px; line-height: 1.5;
    }

    /* BARRA INFERIOR */
    .status-bar {
      height: 32px; background: var(--bg-status); border-top: 1px solid #333;
      display: flex; align-items: center; justify-content: space-between; padding: 0 10px;
      font-size: 11px; color: #888;
    }
    .status-left, .status-right { display: flex; align-items: center; gap: 10px; }
    
    .footer-btn {
      background: #252525; border: 1px solid #3a3a3a; color: #ccc;
      padding: 3px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;
    }
    .footer-btn:hover { background: #333; color: #fff; }
    .footer-btn.cloud-active { border-color: #4cc2ff; color: #4cc2ff; }
    
    /* Notification Toast */
    #toast {
      position: fixed; bottom: 50px; right: 20px; background: #333; color: #fff;
      padding: 10px 20px; border-radius: 4px; border: 1px solid #555;
      opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 9999;
    }
  </style>
</head>
<body>

  <div id="loginOverlay" class="overlay">
    <div class="box">
      <div class="app-icon" style="margin: 0 auto 15px auto;"></div>
      <h2>Acesso Restrito</h2>
      <input type="password" id="loginPass" class="input-field" placeholder="Digite a senha..." />
      <button id="loginBtn" class="btn">Entrar</button>
      <div id="loginError" class="error-msg">Senha incorreta</div>
    </div>
  </div>

  <div id="gistOverlay" class="overlay" style="display: none;">
    <div class="box">
      <h2>☁️ Conectar GitHub Gist</h2>
      <p>Cole seu <b>Personal Access Token (Classic)</b> do GitHub com permissão de 'gist' para salvar automaticamente na nuvem.</p>
      <input type="text" id="gistTokenInput" class="input-field" placeholder="ghp_..." />
      <button id="saveTokenBtn" class="btn">Conectar</button>
      <button id="cancelTokenBtn" class="btn btn-secondary">Cancelar</button>
    </div>
  </div>

  <div class="window">
    <div class="tab-bar">
      <div class="app-icon"></div>
      <div class="tabs-container" id="tabsContainer"></div>
      <button class="add-tab" id="addTabBtn">+</button>
    </div>

    <div class="content">
      <textarea id="editor" class="editor" spellcheck="false" placeholder="Escreva aqui..."></textarea>
      
      <div class="status-bar">
        <div class="status-left">
          <span id="statusInfo">Linhas: 1 | Caracteres: 0</span>
        </div>
        <div class="status-right">
          <button id="cloudBtn" class="footer-btn">☁️ Configurar Nuvem</button>
          <button id="saveTxtBtn" class="footer-btn">⬇️ Baixar .txt</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast">Salvando na nuvem...</div>

<script>
  // ============================================
  //   1. CONFIGURAÇÕES
  // ============================================
  const MINHA_SENHA = "binho@31"; // Troque aqui
  
  // ============================================
  //   2. LOGIN INICIAL
  // ============================================
  const loginOverlay = document.getElementById('loginOverlay');
  const loginPass = document.getElementById('loginPass');
  const loginBtn = document.getElementById('loginBtn');
  const params = new URLSearchParams(window.location.search);

  function doLogin() {
    if(loginPass.value === MINHA_SENHA) {
      loginOverlay.style.display = 'none';
      initApp();
    } else {
      document.getElementById('loginError').style.display = 'block';
    }
  }

  if (params.get("senha") === MINHA_SENHA) {
    loginOverlay.style.display = 'none';
    window.addEventListener('load', initApp);
  } else {
    loginBtn.addEventListener('click', doLogin);
    loginPass.addEventListener('keyup', (e) => { if(e.key === 'Enter') doLogin(); });
  }

  // ============================================
  //   3. APLICAÇÃO PRINCIPAL
  // ============================================
  let tabs = [{id: 1, title: 'Nota 1', content: ''}];
  let activeId = 1;
  let ghToken = localStorage.getItem('gh_token');
  let gistId = localStorage.getItem('gist_id');
  let saveTimeout = null;

  const editor = document.getElementById('editor');
  const tabsContainer = document.getElementById('tabsContainer');
  const statusInfo = document.getElementById('statusInfo');
  const cloudBtn = document.getElementById('cloudBtn');
  const toast = document.getElementById('toast');

  // Inicializa
  async function initApp() {
    // Carrega do LocalStorage primeiro (para ser rápido)
    const savedTabs = localStorage.getItem('local_tabs');
    if (savedTabs) {
      tabs = JSON.parse(savedTabs);
      activeId = tabs[0].id;
    }

    renderTabs();
    setActiveTab(activeId);
    
    // Se tiver Token, tenta carregar da nuvem
    if (ghToken) {
      updateCloudStatus(true);
      await loadFromCloud();
    }
  }

  function updateCloudStatus(active) {
    if (active) {
      cloudBtn.classList.add('cloud-active');
      cloudBtn.textContent = '☁️ Sincronizado';
      cloudBtn.title = 'Conectado ao Gist. ID: ' + (gistId || 'criando...');
    } else {
      cloudBtn.classList.remove('cloud-active');
      cloudBtn.textContent = '☁️ Configurar Nuvem';
    }
  }

  // --- LOGICA DE ABAS ---
  function renderTabs() {
    tabsContainer.innerHTML = '';
    tabs.forEach(tab => {
      const el = document.createElement('div');
      el.className = 'tab ' + (tab.id === activeId ? 'active' : '');
      el.innerHTML = `<span>${tab.title}</span> <button class="tab-close">×</button>`;
      el.onclick = (e) => {
        if(e.target.classList.contains('tab-close')) {
          e.stopPropagation(); closeTab(tab.id);
        } else {
          setActiveTab(tab.id);
        }
      };
      el.querySelector('span').ondblclick = (e) => {
        e.stopPropagation();
        const newTitle = prompt("Novo nome:", tab.title);
        if(newTitle) { tab.title = newTitle; renderTabs(); triggerSave(); }
      };
      tabsContainer.appendChild(el);
    });
  }

  function setActiveTab(id) {
    // Salva o atual antes de mudar
    const currentTab = tabs.find(t => t.id === activeId);
    if(currentTab) currentTab.content = editor.value;

    activeId = id;
    const nextTab = tabs.find(t => t.id === activeId);
    if(nextTab) {
      editor.value = nextTab.content;
      updateStatus();
    }
    renderTabs();
  }

  function closeTab(id) {
    if(tabs.length === 1) {
      tabs[0].content = ''; tabs[0].title = 'Nota 1';
      setActiveTab(tabs[0].id);
      triggerSave();
      return;
    }
    const idx = tabs.findIndex(t => t.id === id);
    tabs.splice(idx, 1);
    // Muda para o anterior ou o primeiro
    setActiveTab(tabs[Math.max(0, idx - 1)].id);
    triggerSave();
  }

  document.getElementById('addTabBtn').onclick = () => {
    const newId = Date.now();
    tabs.push({ id: newId, title: 'Nova Nota', content: '' });
    setActiveTab(newId);
    triggerSave();
  };

  // --- EDITOR & AUTOSAVE LOCAL ---
  editor.addEventListener('input', () => {
    const tab = tabs.find(t => t.id === activeId);
    if(tab) tab.content = editor.value;
    updateStatus();
    triggerSave(); // Salva local e na nuvem (com delay)
  });

  function updateStatus() {
    statusInfo.textContent = `Linhas: ${editor.value.split('\n').length} | Caracteres: ${editor.value.length}`;
  }

  function triggerSave() {
    // 1. Salva no navegador instantaneamente
    localStorage.setItem('local_tabs', JSON.stringify(tabs));
    
    // 2. Agenda salvamento na nuvem (debounce de 3 segundos para não floofar API)
    if (ghToken) {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveToCloud, 3000);
    }
  }

  // ============================================
  //   4. INTEGRAÇÃO GITHUB GIST (A MÁGICA)
  // ============================================
  
  // Configuração UI
  const gistOverlay = document.getElementById('gistOverlay');
  const gistTokenInput = document.getElementById('gistTokenInput');

  cloudBtn.onclick = () => {
    if(ghToken) {
      if(confirm('Já está conectado! Deseja desconectar e parar de salvar na nuvem?')) {
        localStorage.removeItem('gh_token');
        localStorage.removeItem('gist_id');
        ghToken = null;
        gistId = null;
        updateCloudStatus(false);
        alert("Desconectado.");
      }
    } else {
      gistOverlay.style.display = 'flex';
    }
  };

  document.getElementById('cancelTokenBtn').onclick = () => gistOverlay.style.display = 'none';

  document.getElementById('saveTokenBtn').onclick = async () => {
    const token = gistTokenInput.value.trim();
    if(!token.startsWith('ghp_')) {
      alert("O token parece inválido. Deve começar com 'ghp_'.");
      return;
    }
    ghToken = token;
    localStorage.setItem('gh_token', token);
    gistOverlay.style.display = 'none';
    showToast("Conectando ao GitHub...");
    
    // Tenta achar backup antigo ou criar um novo
    await loadFromCloud();
    updateCloudStatus(true);
  };

  // Função: Baixar da Nuvem
  async function loadFromCloud() {
    if(!ghToken) return;
    
    try {
      // Se já temos um ID salvo, busca direto ele
      if (gistId) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
          headers: { Authorization: `token ${ghToken}` }
        });
        if(res.ok) {
          const data = await res.json();
          const fileContent = data.files['notepad_data.json'].content;
          mergeData(JSON.parse(fileContent));
          return;
        } else {
          // Se falhou (deletado?), reseta o ID e tenta buscar na lista
          gistId = null; 
        }
      }

      // Se não tem ID, lista os Gists do usuário para ver se acha o nosso
      const resList = await fetch('https://api.github.com/gists', {
        headers: { Authorization: `token ${ghToken}` }
      });
      const gists = await resList.json();
      const myGist = gists.find(g => g.files['notepad_data.json']);

      if (myGist) {
        // Achou um backup antigo!
        gistId = myGist.id;
        localStorage.setItem('gist_id', gistId);
        const rawUrl = myGist.files['notepad_data.json'].raw_url;
        const contentRes = await fetch(rawUrl);
        const contentJson = await contentRes.json();
        mergeData(contentJson);
        showToast("Dados recuperados da nuvem!");
      } else {
        // Não existe, vamos criar o primeiro save
        saveToCloud(true);
      }

    } catch (e) {
      console.error(e);
      showToast("Erro ao conectar na nuvem.");
    }
  }

  function mergeData(cloudTabs) {
    // Simples substituição: A nuvem ganha se tiver dados
    if(cloudTabs && Array.isArray(cloudTabs) && cloudTabs.length > 0) {
      tabs = cloudTabs;
      activeId = tabs[0].id;
      renderTabs();
      setActiveTab(activeId);
      localStorage.setItem('local_tabs', JSON.stringify(tabs));
    }
  }

  // Função: Salvar na Nuvem
  async function saveToCloud(isNew = false) {
    if(!ghToken) return;
    showToast("Sincronizando...");

    const payload = {
      description: "Backup Automático - Bloco de Notas Juca",
      public: false, // Cria um Gist Privado (Secreto)
      files: {
        "notepad_data.json": {
          content: JSON.stringify(tabs, null, 2)
        }
      }
    };

    try {
      let url = 'https://api.github.com/gists';
      let method = 'POST';

      if (!isNew && gistId) {
        url += `/${gistId}`;
        method = 'PATCH';
      }

      const res = await fetch(url, {
        method: method,
        headers: {
          Authorization: `token ${ghToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        const data = await res.json();
        if(!gistId) {
          gistId = data.id;
          localStorage.setItem('gist_id', gistId);
        }
        showToast("☁️ Salvo na nuvem!");
      } else {
        showToast("Erro ao salvar na nuvem.");
      }
    } catch (e) {
      console.error(e);
    }
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.opacity = '1';
    setTimeout(() => toast.style.opacity = '0', 2500);
  }

  // Download TXT
  document.getElementById('saveTxtBtn').onclick = () => {
    const tab = tabs.find(t => t.id === activeId);
    const blob = new Blob([tab.content], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = tab.title + '.txt';
    a.click();
  };

</script>
</body>
</html>