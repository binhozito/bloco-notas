<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bloco de Notas Juca (Cloud)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ========================================= */
    /* SEU CSS ORIGINAL (INTACTO)           */
    /* ========================================= */
    :root {
      --bg-body: #050505; --bg-window: #202020; --bg-window-alt: #1b1b1b;
      --bg-titlebar: #2b2b2b; --bg-tabbar: #252525; --bg-tab-active: #333333;
      --bg-tab-hover: #303030; --bg-status: #191919; --fg-text: #f5f5f5;
      --fg-text-muted: #a5a5a5; --border-window: #323232; --border-tab: #3a3a3a;
      --accent: #4cc2ff;
      --font-ui: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-mono: "Cascadia Code", "Consolas", "Courier New", monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    body {
      background: radial-gradient(circle at top left, #202020 0, #050505 40%, #000 100%);
      color: var(--fg-text); font-family: var(--font-ui); display: flex;
    }
    .window {
      width: 100vw; height: 100vh; background: radial-gradient(circle at top, #262626 0, #171717 45%, #121212 100%);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .app-icon {
      width: 18px; height: 18px; border-radius: 4px;
      background: linear-gradient(to bottom, #3aa7ff 0%, #2c8be0 40%, #1f6fbf 70%, #14508f 100%);
      position: relative; overflow: hidden; margin-right: 6px; flex-shrink: 0;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.7); align-self: center;
    }
    .app-icon::before {
      content: ""; position: absolute; left: 4px; right: 4px; top: 4px; height: 2px;
      background: #ffffff; border-radius: 2px; box-shadow: 0 3px 0 #ffffff, 0 6px 0 #ffffff;
    }
    .app-icon::after {
      content: ""; position: absolute; left: 0; right: 0; bottom: 0; height: 3px; background: #f8a33b;
    }
    .tab-bar {
      height: 34px; background: var(--bg-tabbar); border-bottom: 1px solid var(--border-tab);
      display: flex; align-items: center; padding: 0 6px; gap: 4px;
    }
    .tab-scroll {
      width: 22px; height: 24px; border: none; background: transparent; color: var(--fg-text-muted);
      display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer;
      flex-shrink: 0; font-size: 14px;
    }
    .tab-scroll:hover:not(:disabled) { background: #3a3a3a; color: #fff; }
    .tab-scroll:disabled { opacity: 0.25; cursor: default; }
    .tabs-viewport { flex: 1; overflow: hidden; display: flex; align-items: flex-end; gap: 4px; }
    .tabs-wrapper { flex: 1; overflow: hidden; }
    .tabs {
      display: flex; align-items: flex-end; gap: 4px; white-space: nowrap;
      overflow-x: auto; overflow-y: hidden; scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      max-width: 220px; min-width: 80px; padding: 6px 10px 4px 10px;
      border-radius: 6px 6px 0 0; background: transparent; border: 1px solid transparent; border-bottom: none;
      display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 12px;
      color: var(--fg-text-muted); cursor: pointer; white-space: nowrap; overflow: hidden;
    }
    .tab:hover { background: var(--bg-tab-hover); color: var(--fg-text); border-color: var(--border-tab); }
    .tab.active {
      background: var(--bg-tab-active); color: var(--fg-text); border-color: var(--border-tab);
      border-bottom: 1px solid var(--bg-window-alt);
    }
    .tab-title { flex: 1; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; line-height: 1; }
    .tab-close {
      background: transparent; border: none; color: var(--fg-text-muted); cursor: pointer;
      font-size: 11px; width: 18px; height: 18px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center; padding: 0;
    }
    .tab-close:hover { background: #444; color: #fff; }
    .tab-add-btn {
      background: transparent; border: none; color: var(--fg-text-muted); cursor: pointer;
      width: 28px; height: 24px; font-size: 18px; margin-left: 4px; align-self: center;
      flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center;
    }
    .tab-add-btn:hover { background: #3a3a3a; color: #fff; border-radius: 6px; }
    .content { flex: 1; display: flex; flex-direction: column; background: var(--bg-window-alt); }
    .find-bar {
      display: none; padding: 10px 16px; background: #181818; border-bottom: 1px solid #323232;
      font-size: 12px; color: #f5f5f5; flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.6); text-align: center;
    }
    .find-row { display: inline-flex; align-items: center; gap: 6px; margin: 3px auto; }
    .find-input, .replace-input {
      width: 260px; max-width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid #3a3a3a;
      background: #111111; color: var(--fg-text); outline: none; font-family: var(--font-ui); font-size: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .find-input::placeholder, .replace-input::placeholder { color: var(--fg-text-muted); }
    .find-input:focus, .replace-input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(76,194,255,0.4); }
    .find-options { display: flex; justify-content: center; gap: 15px; margin-top: 6px; font-size: 11px; color: var(--fg-text-muted); }
    .find-options label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
    .find-options input { margin: 0; cursor: pointer; accent-color: var(--accent); }
    .fr-btn {
      padding: 6px 12px; border-radius: 6px; border: 1px solid #3a3a3a; background: #262626; color: var(--fg-text-muted);
      font-size: 12px; cursor: pointer; outline: none; display: inline-flex; align-items: center; justify-content: center;
      gap: 4px; transition: all 0.15s ease;
    }
    .fr-btn:hover { background: #333333; border-color: #4a4a4a; color: var(--fg-text); }
    .fr-btn.icon { width: 26px; padding: 6px 0; font-size: 11px; }
    .fr-btn.primary {
      background: var(--accent); border-color: #62d0ff; color: #000; font-weight: 500;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 0 10px rgba(76,194,255,0.4);
    }
    .fr-btn.primary:hover { background: #5fd1ff; }
    .fr-btn.danger { background: transparent; border-color: transparent; color: #888888; }
    .fr-btn.danger:hover { background: #3a1919; border-color: #a53333; color: #ff8787; }
    .editor-wrapper { flex: 1; padding: 10px; position: relative; white-space: normal; word-break: break-word; }
    .editor {
      width: 100%; height: 100%; background: transparent; border: none; resize: none;
      outline: none; color: var(--fg-text); font-family: Arial, Helvetica, sans-serif;
      font-size: 17px; line-height: 1.1; caret-color: var(--accent); scrollbar-width: none;
    }
    .editor::-webkit-scrollbar { width: 0; height: 0; }
    .editor::selection { background: #4cc2ff; color: #000; }
    .status-bar {
      height: 28px; background: var(--bg-status); border-top: 1px solid #333333;
      display: flex; align-items: center; justify-content: space-between; padding: 0 10px;
      font-size: 12px; color: var(--fg-text-muted);
    }
    .status-group { display: flex; align-items: center; gap: 6px; }
    .status-pill {
      padding: 2px 10px; border-radius: 999px; background: #252525; border: 1px solid #303030;
      box-shadow: 0 1px 0 rgba(0,0,0,0.7); color: #909090;
    }
    .status-divider { width: 1px; height: 14px; background: #414141; margin: 0 4px; }
    .save-btn {
      background: transparent; border: 1px solid #3a3a3a; color: var(--fg-text-muted);
      font-size: 11px; padding: 2px 12px; border-radius: 4px; cursor: pointer;
      transition: all 0.2s ease; font-family: var(--font-ui);
    }
    .save-btn:hover { background: #333; color: #fff; border-color: #555; }
    .fake-scrollbar {
      position: absolute; right: 4px; top: 2px; width: 4px; border-radius: 999px;
      background: rgba(200, 200, 200, 0.9); opacity: 0; pointer-events: none; transition: opacity 0.15s ease-out;
    }

    /* ========================================= */
    /* CSS ADICIONAL: LOGIN & CLOUD         */
    /* ========================================= */
    .overlay-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #050505; z-index: 9999;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
    }
    .dialog-box {
      background: var(--bg-window); padding: 30px; border-radius: 8px;
      border: 1px solid var(--border-window); text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 320px;
    }
    .dialog-box h2 { margin-bottom: 20px; font-size: 18px; color: var(--accent); }
    .dialog-box p { font-size: 12px; color: #999; margin-bottom: 15px; }
    .login-input {
      width: 100%; padding: 10px; margin-bottom: 15px; background: #111;
      border: 1px solid #333; color: white; border-radius: 4px; outline: none;
    }
    .login-input:focus { border-color: var(--accent); }
    .dialog-btn {
      width: 100%; padding: 10px; background: var(--accent); border: none;
      color: #000; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 5px;
    }
    .dialog-btn:hover { background: #5fd1ff; }
    .dialog-btn.cancel { background: #333; color: #ccc; margin-top: 10px; }
    .login-error { color: #ff5555; font-size: 12px; margin-top: 10px; display: none; }
    
    .cloud-btn {
      background: transparent; border: 1px solid #3a3a3a; color: var(--fg-text-muted);
      font-size: 11px; padding: 2px 12px; border-radius: 4px; cursor: pointer;
      margin-right: 8px; transition: all 0.2s ease;
    }
    .cloud-btn:hover { background: #333; color: #fff; }
    .cloud-active { color: #4cc2ff; border-color: #4cc2ff; }
    
    #toast {
      position: fixed; bottom: 50px; right: 20px; background: #333; color: #fff;
      padding: 8px 16px; border-radius: 4px; border: 1px solid #555;
      font-size: 12px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 9999;
    }
  </style>
</head>

<body>

  <div id="loginOverlay" class="overlay-screen">
    <div class="dialog-box">
      <div class="app-icon" style="margin: 0 auto 15px auto; width: 32px; height: 32px;"></div>
      <h2>Acesso Restrito</h2>
      <input type="password" id="loginPass" class="login-input" placeholder="Digite a senha..." />
      <button id="loginBtn" class="dialog-btn">Entrar</button>
      <div id="loginError" class="login-error">Senha incorreta</div>
    </div>
  </div>

  <div id="gistOverlay" class="overlay-screen" style="display: none; background: rgba(0,0,0,0.85);">
    <div class="dialog-box">
      <h2>☁️ Sincronizar (GitHub)</h2>
      <p>Cole seu Token (Classic) com permissão 'gist' para salvar automaticamente na nuvem.</p>
      <input type="text" id="gistTokenInput" class="login-input" placeholder="ghp_..." />
      <button id="saveTokenBtn" class="dialog-btn">Conectar</button>
      <button id="cancelTokenBtn" class="dialog-btn cancel">Cancelar / Desconectar</button>
    </div>
  </div>

  <div class="window" id="notepadWindow">
    <div class="tab-bar">
      <div class="app-icon"></div>
      <button class="tab-scroll" id="tabScrollLeft">◀</button>
      <div class="tabs-viewport">
        <div class="tabs-wrapper">
          <div class="tabs" id="tabsContainer">
            <button class="tab-add-btn" id="addTabBtnInner">+</button>
          </div>
        </div>
      </div>
      <button class="tab-scroll" id="tabScrollRight">▶</button>
      <button class="tab-add-btn" id="addTabBtnOuter">+</button>
    </div>

    <div class="content">
      <div class="find-bar" id="findBar">
        <div class="find-row">
          <input type="text" id="findInput" class="find-input" placeholder="Localizar" />
          <button class="fr-btn danger" id="findCloseBtn">✕</button>
          <button class="fr-btn icon" id="findPrevBtn">↑</button>
          <button class="fr-btn icon" id="findNextBtn">↓</button>
        </div>
        <div class="find-row">
          <input type="text" id="replaceInput" class="replace-input" placeholder="Substituir por" />
          <button class="fr-btn" id="replaceBtn">Substituir</button>
          <button class="fr-btn primary" id="replaceAllBtn">Substituir tudo</button>
        </div>
        <div class="find-options">
          <label><input type="radio" name="searchType" value="exact" checked /> Pesquisa Exata</label>
          <label><input type="radio" name="searchType" value="free" /> Pesquisa Livre</label>
        </div>
      </div>

      <div class="editor-wrapper">
        <textarea id="editor" class="editor" spellcheck="false"></textarea>
      </div>

      <div class="status-bar">
        <div class="status-group">
          <span id="statusLines" class="status-pill">Linhas: 1</span>
          <span class="status-divider"></span>
          <span id="statusWords" class="status-pill">Palavras: 0</span>
          <span class="status-divider"></span>
          <span id="statusChars" class="status-pill">Caracteres: 0</span>
        </div>
        <div class="status-group">
          <button id="cloudBtn" class="cloud-btn">☁️ Nuvem</button>
          <button id="saveBtn" class="save-btn">Salvar .txt</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast">Salvando...</div>

<script>
  // ============================================
  //   CONFIGURAÇÃO DA SENHA E LOGIN
  // ============================================
  const MINHA_SENHA = "binho@31"; // <-- SUA SENHA AQUI

  const loginOverlay = document.getElementById('loginOverlay');
  const loginPass = document.getElementById('loginPass');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  // Login Automático via Link (?senha=1234)
  const params = new URLSearchParams(window.location.search);
  if (params.get("senha") === MINHA_SENHA) {
    loginOverlay.style.display = 'none';
  }

  function checkLogin() {
    if (loginPass.value === MINHA_SENHA) {
      loginOverlay.style.display = 'none';
      editor.focus();
    } else {
      loginError.style.display = 'block';
      loginPass.value = ''; loginPass.focus();
    }
  }
  loginBtn.addEventListener('click', checkLogin);
  loginPass.addEventListener('keyup', (e) => { if (e.key === 'Enter') checkLogin(); });

  // ============================================
  //   LÓGICA ORIGINAL DO BLOCO DE NOTAS
  // ============================================
  const editor = document.getElementById("editor");
  const editorWrapper = document.querySelector(".editor-wrapper");
  const fakeScrollbar = document.createElement("div");
  fakeScrollbar.className = "fake-scrollbar";
  editorWrapper.appendChild(fakeScrollbar);
  let scrollTimeout = null;
  let suppressScrollBar = false; 

  function showEditorScrollbar() {
    const scrollHeight = editor.scrollHeight;
    const clientHeight = editor.clientHeight;
    if (scrollHeight <= clientHeight) { fakeScrollbar.style.opacity = "0"; return; }
    const trackHeight = editorWrapper.clientHeight;
    const ratio = clientHeight / scrollHeight;
    const thumbHeight = Math.max(20, trackHeight * ratio);
    const maxScrollTop = scrollHeight - clientHeight;
    const maxThumbTop = trackHeight - thumbHeight;
    const thumbTop = maxScrollTop > 0 ? (editor.scrollTop / maxScrollTop) * maxThumbTop : 0;
    fakeScrollbar.style.height = thumbHeight + "px";
    fakeScrollbar.style.top = thumbTop + "px";
    fakeScrollbar.style.opacity = "1";
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => { fakeScrollbar.style.opacity = "0"; }, 700);
  }
  function handleEditorScroll() { if (suppressScrollBar) return; showEditorScrollbar(); }
  editor.addEventListener("scroll", handleEditorScroll);
  editor.addEventListener("wheel", () => {
    const before = editor.scrollTop;
    requestAnimationFrame(() => { if (editor.scrollTop !== before) showEditorScrollbar(); });
  });

  const statusLines = document.getElementById("statusLines");
  const statusWords = document.getElementById("statusWords");
  const statusChars = document.getElementById("statusChars"); // <-- VOLTOU
  const tabsContainer = document.getElementById("tabsContainer");
  const addTabBtnInner = document.getElementById("addTabBtnInner");
  const addTabBtnOuter = document.getElementById("addTabBtnOuter");
  const tabScrollLeftBtn = document.getElementById("tabScrollLeft");
  const tabScrollRightBtn = document.getElementById("tabScrollRight");
  const tabsWrapper = document.querySelector(".tabs-wrapper");
  
  // Find/Replace Vars
  const findBar = document.getElementById("findBar");
  const findInput = document.getElementById("findInput");
  const replaceInput = document.getElementById("replaceInput");
  const findCloseBtn = document.getElementById("findCloseBtn");
  const findPrevBtn = document.getElementById("findPrevBtn");
  const findNextBtn = document.getElementById("findNextBtn");
  const replaceBtn = document.getElementById("replaceBtn");
  const replaceAllBtn = document.getElementById("replaceAllBtn");
  let findMatches = [];
  let findIndex = -1;
  let findBarVisible = false;

  const saveBtn = document.getElementById("saveBtn");

  // DB Setup (IndexedDB)
  const DB_NAME = "NotepadDB";
  const DB_VERSION = 1;
  const STORE_NAME = "appState";
  let db = null;

  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
      };
      request.onsuccess = (event) => { db = event.target.result; resolve(db); };
      request.onerror = () => reject("Erro DB");
    });
  }
  function saveStateDB(state) {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).put(state, "currentState");
  }
  function loadStateDB() {
    return new Promise((resolve) => {
      if (!db) return resolve(null);
      const tx = db.transaction([STORE_NAME], "readonly");
      const req = tx.objectStore(STORE_NAME).get("currentState");
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => resolve(null);
    });
  }

  let tabs = [];
  let activeTabId = null;
  let draggingTabId = null;

  // ============================================
  //   INTEGRAÇÃO GITHUB GIST (INJETADO AQUI)
  // ============================================
  let ghToken = localStorage.getItem('gh_token');
  let gistId = localStorage.getItem('gist_id');
  let cloudSaveTimeout = null;
  const cloudBtn = document.getElementById('cloudBtn');
  const gistOverlay = document.getElementById('gistOverlay');
  const gistTokenInput = document.getElementById('gistTokenInput');
  const saveTokenBtn = document.getElementById('saveTokenBtn');
  const cancelTokenBtn = document.getElementById('cancelTokenBtn');
  const toast = document.getElementById('toast');

  function updateCloudBtnUI() {
    if (ghToken) {
      cloudBtn.classList.add('cloud-active');
      cloudBtn.textContent = '☁️ Sync ON';
    } else {
      cloudBtn.classList.remove('cloud-active');
      cloudBtn.textContent = '☁️ Nuvem';
    }
  }

  cloudBtn.addEventListener('click', () => {
    gistOverlay.style.display = 'flex';
    gistTokenInput.value = ghToken || '';
  });

  cancelTokenBtn.addEventListener('click', () => {
    if (ghToken && confirm("Deseja desconectar e parar a sincronização?")) {
      ghToken = null; gistId = null;
      localStorage.removeItem('gh_token');
      localStorage.removeItem('gist_id');
      updateCloudBtnUI();
    }
    gistOverlay.style.display = 'none';
  });

  saveTokenBtn.addEventListener('click', async () => {
    const token = gistTokenInput.value.trim();
    if (!token.startsWith('ghp_')) { alert("Token inválido (deve começar com ghp_)"); return; }
    ghToken = token;
    localStorage.setItem('gh_token', token);
    gistOverlay.style.display = 'none';
    showToast("Conectando...");
    await loadFromCloud(); // Tenta puxar backup ao conectar
    updateCloudBtnUI();
  });

  function showToast(msg) {
    toast.textContent = msg; toast.style.opacity = '1';
    setTimeout(() => toast.style.opacity = '0', 3000);
  }

  async function loadFromCloud() {
    if(!ghToken) return;
    try {
      // 1. Tenta pelo ID salvo
      if(gistId) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {headers: {Authorization: `token ${ghToken}`}});
        if(res.ok) {
           const data = await res.json();
           const content = JSON.parse(data.files['notepad_data.json'].content);
           applyCloudData(content);
           return;
        } else { gistId = null; }
      }
      // 2. Busca na lista de Gists
      const listRes = await fetch('https://api.github.com/gists', {headers: {Authorization: `token ${ghToken}`}});
      const gists = await listRes.json();
      const backup = gists.find(g => g.files['notepad_data.json']);
      if(backup) {
        gistId = backup.id; localStorage.setItem('gist_id', gistId);
        const rawRes = await fetch(backup.files['notepad_data.json'].raw_url);
        const content = await rawRes.json();
        applyCloudData(content);
        showToast("Dados restaurados da nuvem!");
      } else {
        triggerCloudSave(true); // Cria novo se não achar
      }
    } catch(e) { console.error(e); showToast("Erro na nuvem"); }
  }

  function applyCloudData(cloudTabs) {
    if(cloudTabs && Array.isArray(cloudTabs) && cloudTabs.length > 0) {
      tabs = cloudTabs;
      if (!tabs.find(t => t.id === activeTabId)) activeTabId = tabs[0].id;
      renderTabs();
      setActiveTab(activeTabId);
    }
  }

  async function triggerCloudSave(forceNew = false) {
    if (!ghToken) return;
    // Debounce: espera parar de digitar
    if (cloudSaveTimeout) clearTimeout(cloudSaveTimeout);
    cloudSaveTimeout = setTimeout(async () => {
      showToast("Sincronizando...");
      const payload = {
        description: "Backup Juca Notepad", public: false,
        files: { "notepad_data.json": { content: JSON.stringify(tabs) } }
      };
      try {
        let url = 'https://api.github.com/gists';
        let method = 'POST';
        if (!forceNew && gistId) { url += `/${gistId}`; method = 'PATCH'; }
        
        const res = await fetch(url, {
          method: method,
          headers: { Authorization: `token ${ghToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(res.ok) {
           const data = await res.json();
           if(!gistId) { gistId = data.id; localStorage.setItem('gist_id', gistId); }
           showToast("☁️ Salvo na Nuvem");
        }
      } catch(e) { showToast("Erro ao salvar"); }
    }, 4000); // Salva 4s após parar de mexer
  }

  // ============================================
  //   CONTINUAÇÃO DA LÓGICA ORIGINAL
  // ============================================

  function updateStatus() {
    const text = editor.value;
    statusLines.textContent = "Linhas: " + text.split("\n").length;
    statusWords.textContent = "Palavras: " + (text.trim().split(/\s+/).filter(w => w).length);
    statusChars.textContent = "Caracteres: " + text.length; // <-- VOLTOU
  }

  function saveState() {
    saveStateDB({ tabs, activeTabId });
    // Gatilho para nuvem inserido aqui
    triggerCloudSave();
  }

  function getNextUntitledNumber() {
    let max = 0;
    tabs.forEach(t => {
      const match = /^Sem título\s+(\d+)$/.exec(t.title);
      if (match) { const num = parseInt(match[1]); if (num > max) max = num; }
    });
    return max + 1;
  }

  function createNewTabObject() {
    return {
      id: Date.now() + Math.random(), title: "Sem título " + getNextUntitledNumber(),
      content: "", scrollTop: 0, selectionStart: 0, selectionEnd: 0
    };
  }

  function updateTabScrollButtons() {
    if (!tabsWrapper) return;
    const maxScrollLeft = tabsContainer.scrollWidth - tabsWrapper.clientWidth;
    if (maxScrollLeft <= 0) {
      tabScrollLeftBtn.style.display = "none"; tabScrollRightBtn.style.display = "none";
      addTabBtnInner.style.display = "inline-flex"; addTabBtnOuter.style.display = "none";
      return;
    }
    tabScrollLeftBtn.style.display = "flex"; tabScrollRightBtn.style.display = "flex";
    const current = tabsContainer.scrollLeft;
    tabScrollLeftBtn.disabled = current <= 0;
    tabScrollRightBtn.disabled = current >= maxScrollLeft - 1;
    addTabBtnInner.style.display = "none"; addTabBtnOuter.style.display = "inline-flex";
  }

  tabScrollLeftBtn.addEventListener("click", () => { tabsContainer.scrollBy({ left: -150, behavior: "smooth" }); });
  tabScrollRightBtn.addEventListener("click", () => { tabsContainer.scrollBy({ left: 150, behavior: "smooth" }); });
  tabsContainer.addEventListener("scroll", updateTabScrollButtons);
  window.addEventListener("resize", updateTabScrollButtons);

  function renderTabs() {
    tabsContainer.innerHTML = "";
    tabs.forEach(tab => {
      const el = document.createElement("div");
      el.className = "tab" + (tab.id === activeTabId ? " active" : "");
      el.dataset.id = tab.id; el.draggable = true;

      const title = document.createElement("span");
      title.className = "tab-title"; title.textContent = tab.title;

      const close = document.createElement("button");
      close.className = "tab-close"; close.textContent = "✕";

      el.appendChild(title); el.appendChild(close);
      tabsContainer.appendChild(el);

      el.addEventListener("click", e => { if (e.target === close) return; setActiveTab(tab.id); });
      close.addEventListener("click", e => { e.stopPropagation(); closeTab(tab.id); });
      title.addEventListener("dblclick", e => {
        e.stopPropagation();
        const novo = prompt("Nome da guia:", tab.title);
        if (novo) { tab.title = novo.trim(); renderTabs(); saveState(); }
      });

      // Drag and Drop (Mantido original)
      el.addEventListener("dragstart", e => { draggingTabId = tab.id; e.dataTransfer.effectAllowed = "move"; });
      el.addEventListener("dragend", () => { draggingTabId = null; });
      el.addEventListener("dragover", e => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; });
      el.addEventListener("drop", e => {
        e.preventDefault();
        if (!draggingTabId || draggingTabId === tab.id) return;
        const fromIndex = tabs.findIndex(t => t.id === draggingTabId);
        const toIndex = tabs.findIndex(t => t.id === tab.id);
        if (fromIndex === -1 || toIndex === -1) return;
        const rect = el.getBoundingClientRect();
        let targetIndex = toIndex;
        if (e.clientX > rect.left + rect.width / 2) targetIndex = toIndex + 1;
        const [moved] = tabs.splice(fromIndex, 1);
        if (targetIndex > fromIndex) targetIndex--;
        tabs.splice(targetIndex, 0, moved);
        saveState(); renderTabs(); updateTabScrollButtons();
      });
    });
    tabsContainer.appendChild(addTabBtnInner);
    updateTabScrollButtons();
  }

  function syncActiveTabViewFromEditor() {
    if (activeTabId == null) return;
    const tab = tabs.find(t => t.id === activeTabId);
    if (!tab) return;
    tab.content = editor.value;
    tab.scrollTop = editor.scrollTop;
    tab.selectionStart = editor.selectionStart;
    tab.selectionEnd = editor.selectionEnd;
    saveState();
  }

  function setActiveTab(id) {
    if (activeTabId !== null && activeTabId !== id) syncActiveTabViewFromEditor();
    activeTabId = id;
    const tab = tabs.find(t => t.id === id);
    if (!tab) return;
    suppressScrollBar = true;
    editor.value = tab.content || "";
    updateStatus();
    requestAnimationFrame(() => {
      editor.setSelectionRange(tab.selectionStart||0, tab.selectionEnd||0);
      editor.scrollTop = tab.scrollTop||0;
      requestAnimationFrame(() => { suppressScrollBar = false; });
    });
    requestAnimationFrame(() => {
      document.querySelectorAll(".tab").forEach(tabEl => {
        tabEl.classList.toggle("active", tabEl.dataset.id == id);
      });
      updateTabScrollButtons();
    });
    saveState();
    if (!findBarVisible) { findMatches = []; findIndex = -1; }
    setTimeout(() => editor.focus(), 0);
  }

  function addTab() {
    const t = createNewTabObject();
    tabs.push(t); renderTabs(); setActiveTab(t.id);
    requestAnimationFrame(() => { tabsContainer.scrollLeft = tabsContainer.scrollWidth; updateTabScrollButtons(); });
  }

  function closeTab(id) {
    if (tabs.length === 1) {
      tabs[0].title = "Sem título 1"; tabs[0].content = "";
      setActiveTab(tabs[0].id); saveState(); return;
    }
    const i = tabs.findIndex(t => t.id === id);
    if (i === -1) return;
    const wasActive = (activeTabId === id);
    tabs.splice(i, 1);
    if (wasActive) { const newIndex = i > 0 ? i - 1 : 0; activeTabId = tabs[newIndex].id; }
    renderTabs(); if (tabs.length > 0) setActiveTab(activeTabId);
    saveState();
  }

  editor.addEventListener("input", () => { syncActiveTabViewFromEditor(); updateStatus(); });
  addTabBtnInner.addEventListener("click", addTab);
  addTabBtnOuter.addEventListener("click", addTab);
  ["select", "click"].forEach(evt => { editor.addEventListener(evt, () => { syncActiveTabViewFromEditor(); }); });
  editor.addEventListener("keyup", e => {
    const moveKeys = ["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End","PageUp","PageDown"];
    if (moveKeys.includes(e.key)) syncActiveTabViewFromEditor();
  });

  // Find Functions (Simplificado para caber, mantendo funcionalidade)
  function openFindBar() {
    if (!findBarVisible) { findBar.style.display = "block"; findBarVisible = true; }
    const sel = editor.value.substring(editor.selectionStart, editor.selectionEnd);
    if (sel && !sel.includes("\n")) findInput.value = sel;
    findInput.focus(); findInput.select();
  }
  function closeFindBar() { findBar.style.display = "none"; findBarVisible = false; editor.focus(); }
  findCloseBtn.addEventListener("click", closeFindBar);
  
  // Download TXT Fallback
  function downloadFileFallback(filename, content) {
    if (!filename.toLowerCase().endsWith(".txt")) filename += ".txt";
    const blob = new Blob([content], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
  saveBtn.addEventListener("click", () => {
    const tab = tabs.find(t => t.id === activeTabId);
    if(tab) downloadFileFallback(tab.title, editor.value);
  });

  window.addEventListener("keydown", e => {
    if (e.ctrlKey && (e.key === "s" || e.key === "S")) { e.preventDefault(); downloadFileFallback("nota", editor.value); }
    if (e.ctrlKey && (e.key === "k" || e.key === "K")) { e.preventDefault(); openFindBar(); }
    if (e.key === "Escape" && findBarVisible) { e.preventDefault(); closeFindBar(); }
  });

  // Init
  window.addEventListener("load", async () => {
    try {
      await openDB();
      const state = await loadStateDB();
      if (state && state.tabs.length > 0) {
        tabs = state.tabs; activeTabId = state.activeTabId;
      } else {
        const first = createNewTabObject(); tabs = [first]; activeTabId = first.id;
      }
    } catch (e) {
      const first = createNewTabObject(); tabs = [first]; activeTabId = first.id;
    }
    renderTabs(); setActiveTab(activeTabId); updateTabScrollButtons(); updateCloudBtnUI();
    
    // Auto load cloud if token exists
    if(ghToken) loadFromCloud();
  });
</script>

</body>
</html>